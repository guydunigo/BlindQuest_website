/*! howler.js v2.0.5 | (c) 2013-2017, James Simpson of GoldFire Studios | MIT License | howlerjs.com */
!function(){"use strict";var e=function(){this.init()};e.prototype={init:function(){var e=this||n;return e._counter=1e3,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.mobileAutoEnable=!0,e._setup(),e},volume:function(e){var o=this||n;if(e=parseFloat(e),o.ctx||_(),void 0!==e&&e>=0&&e<=1){if(o._volume=e,o._muted)return o;o.usingWebAudio&&(o.masterGain.gain.value=e);for(var t=0;t<o._howls.length;t++)if(!o._howls[t]._webAudio)for(var r=o._howls[t]._getSoundIds(),a=0;a<r.length;a++){var u=o._howls[t]._soundById(r[a]);u&&u._node&&(u._node.volume=u._volume*e)}return o}return o._volume},mute:function(e){var o=this||n;o.ctx||_(),o._muted=e,o.usingWebAudio&&(o.masterGain.gain.value=e?0:o._volume);for(var t=0;t<o._howls.length;t++)if(!o._howls[t]._webAudio)for(var r=o._howls[t]._getSoundIds(),a=0;a<r.length;a++){var u=o._howls[t]._soundById(r[a]);u&&u._node&&(u._node.muted=!!e||u._muted)}return o},unload:function(){for(var e=this||n,o=e._howls.length-1;o>=0;o--)e._howls[o].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,_()),e},codecs:function(e){return(this||n)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||n;if(e.state=e.ctx?e.ctx.state||"running":"running",e._autoSuspend(),!e.usingWebAudio)if("undefined"!=typeof Audio)try{var o=new Audio;void 0===o.oncanplaythrough&&(e._canPlayEvent="canplay")}catch(n){e.noAudio=!0}else e.noAudio=!0;try{var o=new Audio;o.muted&&(e.noAudio=!0)}catch(e){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||n,o=null;try{o="undefined"!=typeof Audio?new Audio:null}catch(n){return e}if(!o||"function"!=typeof o.canPlayType)return e;var t=o.canPlayType("audio/mpeg;").replace(/^no$/,""),r=e._navigator&&e._navigator.userAgent.match(/OPR\/([0-6].)/g),a=r&&parseInt(r[0].split("/")[1],10)<33;return e._codecs={mp3:!(a||!t&&!o.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!t,opus:!!o.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!o.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!o.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!o.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(o.canPlayType("audio/x-m4a;")||o.canPlayType("audio/m4a;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(o.canPlayType("audio/x-mp4;")||o.canPlayType("audio/mp4;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!o.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(o.canPlayType("audio/x-flac;")||o.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_enableMobileAudio:function(){var e=this||n,o=/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(e._navigator&&e._navigator.userAgent),t=!!("ontouchend"in window||e._navigator&&e._navigator.maxTouchPoints>0||e._navigator&&e._navigator.msMaxTouchPoints>0);if(!e._mobileEnabled&&e.ctx&&(o||t)){e._mobileEnabled=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var r=function(){n._autoResume();var o=e.ctx.createBufferSource();o.buffer=e._scratchBuffer,o.connect(e.ctx.destination),void 0===o.start?o.noteOn(0):o.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),o.onended=function(){o.disconnect(0),e._mobileEnabled=!0,e.mobileAutoEnable=!1,document.removeEventListener("touchstart",r,!0),document.removeEventListener("touchend",r,!0)}};return document.addEventListener("touchstart",r,!0),document.addEventListener("touchend",r,!0),e}},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&n.usingWebAudio){for(var o=0;o<e._howls.length;o++)if(e._howls[o]._webAudio)for(var t=0;t<e._howls[o]._sounds.length;t++)if(!e._howls[o]._sounds[t]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){e.autoSuspend&&(e._suspendTimer=null,e.state="suspending",e.ctx.suspend().then(function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())}))},3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&n.usingWebAudio)return"running"===e.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state?(e.ctx.resume().then(function(){e.state="running";for(var n=0;n<e._howls.length;n++)e._howls[n]._emit("resume")}),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}};var n=new e,o=function(e){var n=this;if(!e.src||0===e.src.length)return void console.error("An array of source files must be passed with any new Howl.");n.init(e)};o.prototype={init:function(e){var o=this;return n.ctx||_(),o._autoplay=e.autoplay||!1,o._format="string"!=typeof e.format?e.format:[e.format],o._html5=e.html5||!1,o._muted=e.mute||!1,o._loop=e.loop||!1,o._pool=e.pool||5,o._preload="boolean"!=typeof e.preload||e.preload,o._rate=e.rate||1,o._sprite=e.sprite||{},o._src="string"!=typeof e.src?e.src:[e.src],o._volume=void 0!==e.volume?e.volume:1,o._xhrWithCredentials=e.xhrWithCredentials||!1,o._duration=0,o._state="unloaded",o._sounds=[],o._endTimers={},o._queue=[],o._onend=e.onend?[{fn:e.onend}]:[],o._onfade=e.onfade?[{fn:e.onfade}]:[],o._onload=e.onload?[{fn:e.onload}]:[],o._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],o._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],o._onpause=e.onpause?[{fn:e.onpause}]:[],o._onplay=e.onplay?[{fn:e.onplay}]:[],o._onstop=e.onstop?[{fn:e.onstop}]:[],o._onmute=e.onmute?[{fn:e.onmute}]:[],o._onvolume=e.onvolume?[{fn:e.onvolume}]:[],o._onrate=e.onrate?[{fn:e.onrate}]:[],o._onseek=e.onseek?[{fn:e.onseek}]:[],o._onresume=[],o._webAudio=n.usingWebAudio&&!o._html5,void 0!==n.ctx&&n.ctx&&n.mobileAutoEnable&&n._enableMobileAudio(),n._howls.push(o),o._autoplay&&o._queue.push({event:"play",action:function(){o.play()}}),o._preload&&o.load(),o},load:function(){var e=this,o=null;if(n.noAudio)return void e._emit("loaderror",null,"No audio support.");"string"==typeof e._src&&(e._src=[e._src]);for(var r=0;r<e._src.length;r++){var u,i;if(e._format&&e._format[r])u=e._format[r];else{if("string"!=typeof(i=e._src[r])){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}u=/^data:audio\/([^;,]+);/i.exec(i),u||(u=/\.([^.]+)$/.exec(i.split("?",1)[0])),u&&(u=u[1].toLowerCase())}if(u||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),u&&n.codecs(u)){o=e._src[r];break}}return o?(e._src=o,e._state="loading","https:"===window.location.protocol&&"http:"===o.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new t(e),e._webAudio&&a(e),e):void e._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(e,o){var t=this,r=null;if("number"==typeof e)r=e,e=null;else{if("string"==typeof e&&"loaded"===t._state&&!t._sprite[e])return null;if(void 0===e){e="__default";for(var a=0,u=0;u<t._sounds.length;u++)t._sounds[u]._paused&&!t._sounds[u]._ended&&(a++,r=t._sounds[u]._id);1===a?e=null:r=null}}var i=r?t._soundById(r):t._inactiveSound();if(!i)return null;if(r&&!e&&(e=i._sprite||"__default"),"loaded"!==t._state){i._sprite=e,i._ended=!1;var d=i._id;return t._queue.push({event:"play",action:function(){t.play(d)}}),d}if(r&&!i._paused)return o||setTimeout(function(){t._emit("play",i._id)},0),i._id;t._webAudio&&n._autoResume();var _=Math.max(0,i._seek>0?i._seek:t._sprite[e][0]/1e3),s=Math.max(0,(t._sprite[e][0]+t._sprite[e][1])/1e3-_),l=1e3*s/Math.abs(i._rate);i._paused=!1,i._ended=!1,i._sprite=e,i._seek=_,i._start=t._sprite[e][0]/1e3,i._stop=(t._sprite[e][0]+t._sprite[e][1])/1e3,i._loop=!(!i._loop&&!t._sprite[e][2]);var c=i._node;if(t._webAudio){var f=function(){t._refreshBuffer(i);var e=i._muted||t._muted?0:i._volume;c.gain.setValueAtTime(e,n.ctx.currentTime),i._playStart=n.ctx.currentTime,void 0===c.bufferSource.start?i._loop?c.bufferSource.noteGrainOn(0,_,86400):c.bufferSource.noteGrainOn(0,_,s):i._loop?c.bufferSource.start(0,_,86400):c.bufferSource.start(0,_,s),l!==1/0&&(t._endTimers[i._id]=setTimeout(t._ended.bind(t,i),l)),o||setTimeout(function(){t._emit("play",i._id)},0)};"running"===n.state?f():(t.once("resume",f),t._clearTimer(i._id))}else{var p=function(){c.currentTime=_,c.muted=i._muted||t._muted||n._muted||c.muted,c.volume=i._volume*n.volume(),c.playbackRate=i._rate;try{if(c.play(),c.paused)return void t._emit("playerror",i._id,"Playback was unable to start. This is most commonly an issue on mobile devices where playback was not within a user interaction.");l!==1/0&&(t._endTimers[i._id]=setTimeout(t._ended.bind(t,i),l)),o||t._emit("play",i._id)}catch(e){t._emit("playerror",i._id,e)}},v=window&&window.ejecta||!c.readyState&&n._navigator.isCocoonJS;if(4===c.readyState||v)p();else{var m=function(){p(),c.removeEventListener(n._canPlayEvent,m,!1)};c.addEventListener(n._canPlayEvent,m,!1),t._clearTimer(i._id)}}return i._id},pause:function(e){var n=this;if("loaded"!==n._state)return n._queue.push({event:"pause",action:function(){n.pause(e)}}),n;for(var o=n._getSoundIds(e),t=0;t<o.length;t++){n._clearTimer(o[t]);var r=n._soundById(o[t]);if(r&&!r._paused&&(r._seek=n.seek(o[t]),r._rateSeek=0,r._paused=!0,n._stopFade(o[t]),r._node))if(n._webAudio){if(!r._node.bufferSource)continue;void 0===r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),n._cleanBuffer(r._node)}else isNaN(r._node.duration)&&r._node.duration!==1/0||r._node.pause();arguments[1]||n._emit("pause",r?r._id:null)}return n},stop:function(e,n){var o=this;if("loaded"!==o._state)return o._queue.push({event:"stop",action:function(){o.stop(e)}}),o;for(var t=o._getSoundIds(e),r=0;r<t.length;r++){o._clearTimer(t[r]);var a=o._soundById(t[r]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,o._stopFade(t[r]),a._node&&(o._webAudio?a._node.bufferSource&&(void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),o._cleanBuffer(a._node)):isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause())),n||o._emit("stop",a._id))}return o},mute:function(e,o){var t=this;if("loaded"!==t._state)return t._queue.push({event:"mute",action:function(){t.mute(e,o)}}),t;if(void 0===o){if("boolean"!=typeof e)return t._muted;t._muted=e}for(var r=t._getSoundIds(o),a=0;a<r.length;a++){var u=t._soundById(r[a]);u&&(u._muted=e,t._webAudio&&u._node?u._node.gain.setValueAtTime(e?0:u._volume,n.ctx.currentTime):u._node&&(u._node.muted=!!n._muted||e),t._emit("mute",u._id))}return t},volume:function(){var e,o,t=this,r=arguments;if(0===r.length)return t._volume;if(1===r.length||2===r.length&&void 0===r[1]){t._getSoundIds().indexOf(r[0])>=0?o=parseInt(r[0],10):e=parseFloat(r[0])}else r.length>=2&&(e=parseFloat(r[0]),o=parseInt(r[1],10));var a;if(!(void 0!==e&&e>=0&&e<=1))return a=o?t._soundById(o):t._sounds[0],a?a._volume:0;if("loaded"!==t._state)return t._queue.push({event:"volume",action:function(){t.volume.apply(t,r)}}),t;void 0===o&&(t._volume=e),o=t._getSoundIds(o);for(var u=0;u<o.length;u++)(a=t._soundById(o[u]))&&(a._volume=e,r[2]||t._stopFade(o[u]),t._webAudio&&a._node&&!a._muted?a._node.gain.setValueAtTime(e,n.ctx.currentTime):a._node&&!a._muted&&(a._node.volume=e*n.volume()),t._emit("volume",a._id));return t},fade:function(e,o,t,r){var a=this;if("loaded"!==a._state)return a._queue.push({event:"fade",action:function(){a.fade(e,o,t,r)}}),a;a.volume(e,r);for(var u=a._getSoundIds(r),i=0;i<u.length;i++){var d=a._soundById(u[i]);if(d){if(r||a._stopFade(u[i]),a._webAudio&&!d._muted){var _=n.ctx.currentTime,s=_+t/1e3;d._volume=e,d._node.gain.setValueAtTime(e,_),d._node.gain.linearRampToValueAtTime(o,s)}a._startFadeInterval(d,e,o,t,u[i])}}return a},_startFadeInterval:function(e,n,o,t,r){var a=this,u=n,i=n>o?"out":"in",d=Math.abs(n-o),_=d/.01,s=_>0?t/_:t;s<4&&(_=Math.ceil(_/(4/s)),s=4),e._interval=setInterval(function(){_>0&&(u+="in"===i?.01:-.01),u=Math.max(0,u),u=Math.min(1,u),u=Math.round(100*u)/100,a._webAudio?(void 0===r&&(a._volume=u),e._volume=u):a.volume(u,e._id,!0),(o<n&&u<=o||o>n&&u>=o)&&(clearInterval(e._interval),e._interval=null,a.volume(o,e._id),a._emit("fade",e._id))},s)},_stopFade:function(e){var o=this,t=o._soundById(e);return t&&t._interval&&(o._webAudio&&t._node.gain.cancelScheduledValues(n.ctx.currentTime),clearInterval(t._interval),t._interval=null,o._emit("fade",e)),o},loop:function(){var e,n,o,t=this,r=arguments;if(0===r.length)return t._loop;if(1===r.length){if("boolean"!=typeof r[0])return!!(o=t._soundById(parseInt(r[0],10)))&&o._loop;e=r[0],t._loop=e}else 2===r.length&&(e=r[0],n=parseInt(r[1],10));for(var a=t._getSoundIds(n),u=0;u<a.length;u++)(o=t._soundById(a[u]))&&(o._loop=e,t._webAudio&&o._node&&o._node.bufferSource&&(o._node.bufferSource.loop=e,e&&(o._node.bufferSource.loopStart=o._start||0,o._node.bufferSource.loopEnd=o._stop)));return t},rate:function(){var e,o,t=this,r=arguments;if(0===r.length)o=t._sounds[0]._id;else if(1===r.length){var a=t._getSoundIds(),u=a.indexOf(r[0]);u>=0?o=parseInt(r[0],10):e=parseFloat(r[0])}else 2===r.length&&(e=parseFloat(r[0]),o=parseInt(r[1],10));var i;if("number"!=typeof e)return i=t._soundById(o),i?i._rate:t._rate;if("loaded"!==t._state)return t._queue.push({event:"rate",action:function(){t.rate.apply(t,r)}}),t;void 0===o&&(t._rate=e),o=t._getSoundIds(o);for(var d=0;d<o.length;d++)if(i=t._soundById(o[d])){i._rateSeek=t.seek(o[d]),i._playStart=t._webAudio?n.ctx.currentTime:i._playStart,i._rate=e,t._webAudio&&i._node&&i._node.bufferSource?i._node.bufferSource.playbackRate.value=e:i._node&&(i._node.playbackRate=e);var _=t.seek(o[d]),s=(t._sprite[i._sprite][0]+t._sprite[i._sprite][1])/1e3-_,l=1e3*s/Math.abs(i._rate);!t._endTimers[o[d]]&&i._paused||(t._clearTimer(o[d]),t._endTimers[o[d]]=setTimeout(t._ended.bind(t,i),l)),t._emit("rate",i._id)}return t},seek:function(){var e,o,t=this,r=arguments;if(0===r.length)o=t._sounds[0]._id;else if(1===r.length){var a=t._getSoundIds(),u=a.indexOf(r[0]);u>=0?o=parseInt(r[0],10):t._sounds.length&&(o=t._sounds[0]._id,e=parseFloat(r[0]))}else 2===r.length&&(e=parseFloat(r[0]),o=parseInt(r[1],10));if(void 0===o)return t;if("loaded"!==t._state)return t._queue.push({event:"seek",action:function(){t.seek.apply(t,r)}}),t;var i=t._soundById(o);if(i){if(!("number"==typeof e&&e>=0)){if(t._webAudio){var d=t.playing(o)?n.ctx.currentTime-i._playStart:0,_=i._rateSeek?i._rateSeek-i._seek:0;return i._seek+(_+d*Math.abs(i._rate))}return i._node.currentTime}var s=t.playing(o);s&&t.pause(o,!0),i._seek=e,i._ended=!1,t._clearTimer(o),s&&t.play(o,!0),!t._webAudio&&i._node&&(i._node.currentTime=e),t._emit("seek",o)}return t},playing:function(e){var n=this;if("number"==typeof e){var o=n._soundById(e);return!!o&&!o._paused}for(var t=0;t<n._sounds.length;t++)if(!n._sounds[t]._paused)return!0;return!1},duration:function(e){var n=this,o=n._duration,t=n._soundById(e);return t&&(o=n._sprite[t._sprite][1]/1e3),o},state:function(){return this._state},unload:function(){for(var e=this,o=e._sounds,t=0;t<o.length;t++){if(o[t]._paused||e.stop(o[t]._id),!e._webAudio){/MSIE |Trident\//.test(n._navigator&&n._navigator.userAgent)||(o[t]._node.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"),o[t]._node.removeEventListener("error",o[t]._errorFn,!1),o[t]._node.removeEventListener(n._canPlayEvent,o[t]._loadFn,!1)}delete o[t]._node,e._clearTimer(o[t]._id);var a=n._howls.indexOf(e);a>=0&&n._howls.splice(a,1)}var u=!0;for(t=0;t<n._howls.length;t++)if(n._howls[t]._src===e._src){u=!1;break}return r&&u&&delete r[e._src],n.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,n,o,t){var r=this,a=r["_on"+e];return"function"==typeof n&&a.push(t?{id:o,fn:n,once:t}:{id:o,fn:n}),r},off:function(e,n,o){var t=this,r=t["_on"+e],a=0;if("number"==typeof n&&(o=n,n=null),n||o)for(a=0;a<r.length;a++){var u=o===r[a].id;if(n===r[a].fn&&u||!n&&u){r.splice(a,1);break}}else if(e)t["_on"+e]=[];else{var i=Object.keys(t);for(a=0;a<i.length;a++)0===i[a].indexOf("_on")&&Array.isArray(t[i[a]])&&(t[i[a]]=[])}return t},once:function(e,n,o){var t=this;return t.on(e,n,o,1),t},_emit:function(e,n,o){for(var t=this,r=t["_on"+e],a=r.length-1;a>=0;a--)r[a].id&&r[a].id!==n&&"load"!==e||(setTimeout(function(e){e.call(this,n,o)}.bind(t,r[a].fn),0),r[a].once&&t.off(e,r[a].fn,r[a].id));return t},_loadQueue:function(){var e=this;if(e._queue.length>0){var n=e._queue[0];e.once(n.event,function(){e._queue.shift(),e._loadQueue()}),n.action()}return e},_ended:function(e){var o=this,t=e._sprite;if(!o._webAudio&&e._node&&!e._node.paused)return setTimeout(o._ended.bind(o,e),100),o;var r=!(!e._loop&&!o._sprite[t][2]);if(o._emit("end",e._id),!o._webAudio&&r&&o.stop(e._id,!0).play(e._id),o._webAudio&&r){o._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=n.ctx.currentTime;var a=1e3*(e._stop-e._start)/Math.abs(e._rate);o._endTimers[e._id]=setTimeout(o._ended.bind(o,e),a)}return o._webAudio&&!r&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,o._clearTimer(e._id),o._cleanBuffer(e._node),n._autoSuspend()),o._webAudio||r||o.stop(e._id),o},_clearTimer:function(e){var n=this;return n._endTimers[e]&&(clearTimeout(n._endTimers[e]),delete n._endTimers[e]),n},_soundById:function(e){for(var n=this,o=0;o<n._sounds.length;o++)if(e===n._sounds[o]._id)return n._sounds[o];return null},_inactiveSound:function(){var e=this;e._drain();for(var n=0;n<e._sounds.length;n++)if(e._sounds[n]._ended)return e._sounds[n].reset();return new t(e)},_drain:function(){var e=this,n=e._pool,o=0,t=0;if(!(e._sounds.length<n)){for(t=0;t<e._sounds.length;t++)e._sounds[t]._ended&&o++;for(t=e._sounds.length-1;t>=0;t--){if(o<=n)return;e._sounds[t]._ended&&(e._webAudio&&e._sounds[t]._node&&e._sounds[t]._node.disconnect(0),e._sounds.splice(t,1),o--)}}},_getSoundIds:function(e){var n=this;if(void 0===e){for(var o=[],t=0;t<n._sounds.length;t++)o.push(n._sounds[t]._id);return o}return[e]},_refreshBuffer:function(e){var o=this;return e._node.bufferSource=n.ctx.createBufferSource(),e._node.bufferSource.buffer=r[o._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop),e._node.bufferSource.playbackRate.value=e._rate,o},_cleanBuffer:function(e){var n=this;if(n._scratchBuffer){e.bufferSource.onended=null,e.bufferSource.disconnect(0);try{e.bufferSource.buffer=n._scratchBuffer}catch(e){}}return e.bufferSource=null,n}};var t=function(e){this._parent=e,this.init()};t.prototype={init:function(){var e=this,o=e._parent;return e._muted=o._muted,e._loop=o._loop,e._volume=o._volume,e._rate=o._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++n._counter,o._sounds.push(e),e.create(),e},create:function(){var e=this,o=e._parent,t=n._muted||e._muted||e._parent._muted?0:e._volume;return o._webAudio?(e._node=void 0===n.ctx.createGain?n.ctx.createGainNode():n.ctx.createGain(),e._node.gain.setValueAtTime(t,n.ctx.currentTime),e._node.paused=!0,e._node.connect(n.masterGain)):(e._node=new Audio,e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(n._canPlayEvent,e._loadFn,!1),e._node.src=o._src,e._node.preload="auto",e._node.volume=t*n.volume(),e._node.load()),e},reset:function(){var e=this,o=e._parent;return e._muted=o._muted,e._loop=o._loop,e._volume=o._volume,e._rate=o._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++n._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this,o=e._parent;o._duration=Math.ceil(10*e._node.duration)/10,0===Object.keys(o._sprite).length&&(o._sprite={__default:[0,1e3*o._duration]}),"loaded"!==o._state&&(o._state="loaded",o._emit("load"),o._loadQueue()),e._node.removeEventListener(n._canPlayEvent,e._loadFn,!1)}};var r={},a=function(e){var n=e._src;if(r[n])return e._duration=r[n].duration,void d(e);if(/^data:[^;]+;base64,/.test(n)){for(var o=atob(n.split(",")[1]),t=new Uint8Array(o.length),a=0;a<o.length;++a)t[a]=o.charCodeAt(a);i(t.buffer,e)}else{var _=new XMLHttpRequest;_.open("GET",n,!0),_.withCredentials=e._xhrWithCredentials,_.responseType="arraybuffer",_.onload=function(){var n=(_.status+"")[0];if("0"!==n&&"2"!==n&&"3"!==n)return void e._emit("loaderror",null,"Failed loading audio file with status: "+_.status+".");i(_.response,e)},_.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete r[n],e.load())},u(_)}},u=function(e){try{e.send()}catch(n){e.onerror()}},i=function(e,o){n.ctx.decodeAudioData(e,function(e){e&&o._sounds.length>0&&(r[o._src]=e,d(o,e))},function(){o._emit("loaderror",null,"Decoding audio data failed.")})},d=function(e,n){n&&!e._duration&&(e._duration=n.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},_=function(){try{"undefined"!=typeof AudioContext?n.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?n.ctx=new webkitAudioContext:n.usingWebAudio=!1}catch(e){n.usingWebAudio=!1}var e=/iP(hone|od|ad)/.test(n._navigator&&n._navigator.platform),o=n._navigator&&n._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),t=o?parseInt(o[1],10):null;if(e&&t&&t<9){var r=/safari/.test(n._navigator&&n._navigator.userAgent.toLowerCase());(n._navigator&&n._navigator.standalone&&!r||n._navigator&&!n._navigator.standalone&&!r)&&(n.usingWebAudio=!1)}n.usingWebAudio&&(n.masterGain=void 0===n.ctx.createGain?n.ctx.createGainNode():n.ctx.createGain(),n.masterGain.gain.value=n._muted?0:1,n.masterGain.connect(n.ctx.destination)),n._setup()};"function"==typeof define&&define.amd&&define([],function(){return{Howler:n,Howl:o}}),"undefined"!=typeof exports&&(exports.Howler=n,exports.Howl=o),"undefined"!=typeof window?(window.HowlerGlobal=e,window.Howler=n,window.Howl=o,window.Sound=t):"undefined"!=typeof global&&(global.HowlerGlobal=e,global.Howler=n,global.Howl=o,global.Sound=t)}();
/*! Spatial Plugin */
!function(){"use strict";HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(n){var e=this;if(!e.ctx||!e.ctx.listener)return e;for(var t=e._howls.length-1;t>=0;t--)e._howls[t].stereo(n);return e},HowlerGlobal.prototype.pos=function(n,e,t){var o=this;return o.ctx&&o.ctx.listener?(e="number"!=typeof e?o._pos[1]:e,t="number"!=typeof t?o._pos[2]:t,"number"!=typeof n?o._pos:(o._pos=[n,e,t],o.ctx.listener.setPosition(o._pos[0],o._pos[1],o._pos[2]),o)):o},HowlerGlobal.prototype.orientation=function(n,e,t,o,r,a){var i=this;if(!i.ctx||!i.ctx.listener)return i;var p=i._orientation;return e="number"!=typeof e?p[1]:e,t="number"!=typeof t?p[2]:t,o="number"!=typeof o?p[3]:o,r="number"!=typeof r?p[4]:r,a="number"!=typeof a?p[5]:a,"number"!=typeof n?p:(i._orientation=[n,e,t,o,r,a],i.ctx.listener.setOrientation(n,e,t,o,r,a),i)},Howl.prototype.init=function(n){return function(e){var t=this;return t._orientation=e.orientation||[1,0,0],t._stereo=e.stereo||null,t._pos=e.pos||null,t._pannerAttr={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:360,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:360,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:0,distanceModel:void 0!==e.distanceModel?e.distanceModel:"inverse",maxDistance:void 0!==e.maxDistance?e.maxDistance:1e4,panningModel:void 0!==e.panningModel?e.panningModel:"HRTF",refDistance:void 0!==e.refDistance?e.refDistance:1,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:1},t._onstereo=e.onstereo?[{fn:e.onstereo}]:[],t._onpos=e.onpos?[{fn:e.onpos}]:[],t._onorientation=e.onorientation?[{fn:e.onorientation}]:[],n.call(this,e)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,t){var o=this;if(!o._webAudio)return o;if("loaded"!==o._state)return o._queue.push({event:"stereo",action:function(){o.stereo(e,t)}}),o;var r=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===t){if("number"!=typeof e)return o._stereo;o._stereo=e,o._pos=[e,0,0]}for(var a=o._getSoundIds(t),i=0;i<a.length;i++){var p=o._soundById(a[i]);if(p){if("number"!=typeof e)return p._stereo;p._stereo=e,p._pos=[e,0,0],p._node&&(p._pannerAttr.panningModel="equalpower",p._panner&&p._panner.pan||n(p,r),"spatial"===r?p._panner.setPosition(e,0,0):p._panner.pan.value=e),o._emit("stereo",p._id)}}return o},Howl.prototype.pos=function(e,t,o,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"pos",action:function(){a.pos(e,t,o,r)}}),a;if(t="number"!=typeof t?0:t,o="number"!=typeof o?-.5:o,void 0===r){if("number"!=typeof e)return a._pos;a._pos=[e,t,o]}for(var i=a._getSoundIds(r),p=0;p<i.length;p++){var s=a._soundById(i[p]);if(s){if("number"!=typeof e)return s._pos;s._pos=[e,t,o],s._node&&(s._panner&&!s._panner.pan||n(s,"spatial"),s._panner.setPosition(e,t,o)),a._emit("pos",s._id)}}return a},Howl.prototype.orientation=function(e,t,o,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"orientation",action:function(){a.orientation(e,t,o,r)}}),a;if(t="number"!=typeof t?a._orientation[1]:t,o="number"!=typeof o?a._orientation[2]:o,void 0===r){if("number"!=typeof e)return a._orientation;a._orientation=[e,t,o]}for(var i=a._getSoundIds(r),p=0;p<i.length;p++){var s=a._soundById(i[p]);if(s){if("number"!=typeof e)return s._orientation;s._orientation=[e,t,o],s._node&&(s._panner||(s._pos||(s._pos=a._pos||[0,0,-.5]),n(s,"spatial")),s._panner.setOrientation(e,t,o)),a._emit("orientation",s._id)}}return a},Howl.prototype.pannerAttr=function(){var e,t,o,r=this,a=arguments;if(!r._webAudio)return r;if(0===a.length)return r._pannerAttr;if(1===a.length){if("object"!=typeof a[0])return o=r._soundById(parseInt(a[0],10)),o?o._pannerAttr:r._pannerAttr;e=a[0],void 0===t&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),r._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:r._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:r._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:r._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:r._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:r._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:r._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:r._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:r._panningModel})}else 2===a.length&&(e=a[0],t=parseInt(a[1],10));for(var i=r._getSoundIds(t),p=0;p<i.length;p++)if(o=r._soundById(i[p])){var s=o._pannerAttr;s={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:s.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:s.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:s.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:s.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:s.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:s.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:s.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:s.panningModel};var l=o._panner;l?(l.coneInnerAngle=s.coneInnerAngle,l.coneOuterAngle=s.coneOuterAngle,l.coneOuterGain=s.coneOuterGain,l.distanceModel=s.distanceModel,l.maxDistance=s.maxDistance,l.refDistance=s.refDistance,l.rolloffFactor=s.rolloffFactor,l.panningModel=s.panningModel):(o._pos||(o._pos=r._pos||[0,0,-.5]),n(o,"spatial"))}return r},Sound.prototype.init=function(n){return function(){var e=this,t=e._parent;e._orientation=t._orientation,e._stereo=t._stereo,e._pos=t._pos,e._pannerAttr=t._pannerAttr,n.call(this),e._stereo?t.stereo(e._stereo):e._pos&&t.pos(e._pos[0],e._pos[1],e._pos[2],e._id)}}(Sound.prototype.init),Sound.prototype.reset=function(n){return function(){var e=this,t=e._parent;return e._orientation=t._orientation,e._pos=t._pos,e._pannerAttr=t._pannerAttr,n.call(this)}}(Sound.prototype.reset);var n=function(n,e){e=e||"spatial","spatial"===e?(n._panner=Howler.ctx.createPanner(),n._panner.coneInnerAngle=n._pannerAttr.coneInnerAngle,n._panner.coneOuterAngle=n._pannerAttr.coneOuterAngle,n._panner.coneOuterGain=n._pannerAttr.coneOuterGain,n._panner.distanceModel=n._pannerAttr.distanceModel,n._panner.maxDistance=n._pannerAttr.maxDistance,n._panner.refDistance=n._pannerAttr.refDistance,n._panner.rolloffFactor=n._pannerAttr.rolloffFactor,n._panner.panningModel=n._pannerAttr.panningModel,n._panner.setPosition(n._pos[0],n._pos[1],n._pos[2]),n._panner.setOrientation(n._orientation[0],n._orientation[1],n._orientation[2])):(n._panner=Howler.ctx.createStereoPanner(),n._panner.pan.value=n._stereo),n._panner.connect(n._node),n._paused||n._parent.pause(n._id,!0).play(n._id)}}();
"use strict";function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}var ENV={CODES:{plain:0,woods:1,cave:2,water:3,castle:4,wood_path:5,bridge:6,sand:7,mountains:8,monster:10,boss:11,boss_final:12,bonus:13,sea:14,castle_gate:15,magic:16,funny:17,border:97,start:98,end:99},SOUNDS:{plain:"plaine",woods:"foret",cave:"caverne",water:"eau_short",castle:"chateau",wood_path:"sentier",bridge:"pont",sand:"sable",mountains:"montagne",monster:"monstre",boss:"monstre",boss_final:"boss_final",bonus:"bonus",sea:"mer",castle_gate:"entreechateau",magic:"magie",funny:"funny",border:"border",start:"depart",end:"depart"},COLORS:{plain:"rgb(150,175,10)",woods:"rgb(0,100,0)",cave:"rgb(100,50,0)",water:"rgb(0,0,255)",castle:"rgb(150,150,150)",wood_path:"rgb(10,200,0)",bridge:"rgb(100,50,0)",sand:"rgb(255,255,0)",mountains:"rgb(50,10,0)",monster:"rgb(200,200,0)",boss:"rgb(100,100,0)",boss_final:"rgb(255,0,0)",bonus:"rgb(238,130,238)",sea:"rgb(20,20,100)",castle_gate:"rgb(50,50,50)",magic:"rgb(139,0,139)",funny:"rgb()",border:"rgb(0,0,0)",start:"rgb(255,255,255)",end:"rgb(10,10,10)"},ROUND:new Set(["monster","boss","boss_final"]),SOUND_BLOCKERS:{}};ENV.SOUND_BLOCKERS[ENV.CODES.border]=0;var BQ={FILENAME:"maps/carte_defaut.json",TIMEBASE:200};var AUDIO={VOLUME_ENV:1,VOLUME_ENV_PLAYER:0.55,VOLUME_ENV_PROX:0.5,VOLUME_ACTION:1,VOLUME_HEART:1,START_MUTE:false};var DEBUG={DISABLE:true,AUDIO:false,AUDIO_STOP:false,AUDIO_PLAY:false,BQ:false,EVENTS:true,EVENTS_REGISTER:false,EVENTS_DIRTY:true,EVENTS_EXEC:false,EVENTS_ADD:false,EVENTS_REMOVE:false,FIGHTS:true,KB:false,TIME:{LIMIT:10,LOAD:false,LOOP:false,BET_LOOPS:false,RULE:false,GETPROXMAP:false}};var DEV_TOOLS={SHOW_LIFE:false,SHOW_PROX_MAP:false,SHOW_WHOLE_MAP:false,SHOW_MAP_TYPE:"square",SHOW_MAP_COLORS:true};var PLAYER={MAX_LIFE:20,DEFAULT_DAMAGES:1,PROBA_HIT:0.85};var MONSTERS={};MONSTERS[ENV.CODES.monster]={id:ENV.CODES.monster,life:1,damages:1,proba_hit:0.5,proba_death:0.2};MONSTERS[ENV.CODES.boss]={id:ENV.CODES.boss,life:2,damages:2,proba_hit:0.5,proba_death:0.2};MONSTERS[ENV.CODES.boss_final]={id:ENV.CODES.boss_final,life:3,damages:3,proba_hit:0.6,proba_death:0.8};var BAD_SQUARES_CODES=new Set([ENV.CODES.bonus,ENV.CODES.mountains,ENV.CODES.border,ENV.CODES.water,ENV.CODES.sea]);var EVENTS={REPORT_DUPLICATES:false};var RULES={MOVE:false};var opts={AUDIO:AUDIO,BAD_SQUARES_CODES:BAD_SQUARES_CODES,BQ:BQ,DEBUG:DEBUG,DEV_TOOLS:DEV_TOOLS,ENV:ENV,EVENTS:EVENTS,MONSTERS:MONSTERS,PLAYER:PLAYER,RULES:RULES};function loadRulesHandlers$1(bq,events){events.register=function(rule){var goodTargets=[];if(rule.events!==undefined){rule.events.forEach(function(targ){if(events.isEventGood(targ)){goodTargets.push(targ);}});}var dest={};if(rule.instant){dest=events.instants;}else{dest=events.rules;}goodTargets.forEach(function(targ){if(dest[targ]instanceof Array){dest[targ].push(rule);}else{dest[targ]=[rule];}if(opts.DEBUG.EVENTS&&opts.DEBUG.EVENTS_REGISTER){bq.interface.disp.console.write("EVENTS REGISTER "+rule.name+" TO "+targ);}});return rule;};events.handle=function(evts){var rulesList=arguments.length>1&&arguments[1]!==undefined?arguments[1]:events.rules;var tree=void 0,rules=void 0,res=false,t_start=Date.now();evts.forEach(function(ev){tree=events.getParentsTree(ev);tree.forEach(function(cat){rules=rulesList[cat];if(rules!==undefined){if(res!==true){res=true;}rules.forEach(function(rule){if(opts.DEBUG.EVENTS&&opts.DEBUG.EVENTS_EXEC){bq.interface.disp.console.write("EVENTS EXEC "+rule.name);}rule.main(bq,ev);if(opts.DEBUG.TIME.RULE&&Date.now()-t_start>opts.DEBUG.TIME.LIMIT){bq.interface.disp.console.write("EVENTS "+(Date.now()-t_start)+"ms FOR "+rule.name);}});}});});return res;};return events;}var Events$1=function Events$1(bq){var events={model:{},rules:{},instants:{},add:undefined,getNext:undefined,isIdle:undefined,getPendings:undefined,getPendingsUniq:undefined,isEvendGood:undefined,getParentsTree:undefined,filterEventsFrom:undefined,eventIsA:undefined,register:undefined,handle:undefined,clean:function clean(){}};events.model={bq:{world:{player:{move:{up:1,down:2,left:3,right:4},moved:5,bonus:6,fight_started:7,attack:8,damaged:9,end_fight:10,life_changed:11,kill:12}},interface:{fullscreen:1001,mute:1002},game:{state:{init:2001,launching:2002,launched:2003,loading:2004,loaded:2005,paused:2006,stopped:2007,won:2008},stop:2008,pause:2009,reset:2010,help:2011,save:2012,load:2013}}};var fifo=[];events.add=function(elmt){if(events.isEventGood(elmt)){if(events.handle([elmt],events.instants)){if(opts.DEBUG.EVENTS&&opts.DEBUG.EVENTS_EXEC){bq.interface.disp.console.write("EVENTS INSTANT "+elmt);}}fifo.push(elmt);if(opts.DEBUG.EVENTS&&opts.DEBUG.EVENTS_ADD){bq.interface.disp.console.write("EVENTS ADDED #"+fifo.length+" "+elmt);}return elmt;}};events.getNext=function(){var res=fifo.shift();if(opts.DEBUG.EVENTS&&opts.DEBUG.EVENTS_REMOVE){bq.interface.disp.console.write("EVENT #"+(fifo.length+1)+" REMOVED "+res);}return res;};events.isIdle=function(){return fifo.length===0;};events.getPendings=function(){var res=[];while(!events.isIdle()){res.push(events.getNext());}return res;};events.getPendingsUniq=function(){var readd_dups=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var evts=events.getPendings();var res=[];evts.forEach(function(evt){if(!res.includes(evt)){res.push(evt);}else if(readd_dups&&opts.EVENTS.REPORT_DUPLICATES){events.add(evt);}});return res;};events.isEventGood=function(event){var tree=event.split("."),tmp=events.model;while(tmp!==undefined&&tree.length>0){tmp=tmp[tree[0]];tree=tree.splice(1);}if(tmp===undefined){if(opts.DEBUG.EVENTS&&opts.DEBUG.EVENTS_DIRTY){bq.interface.disp.console.write("EVENTS DIRTY "+event);}}return tmp!==undefined;};events.getParentsTree=function(event){var parents=event.split("."),res=[];var tmp=void 0;parents.forEach(function(par){tmp="";if(res.length>0){tmp=res[res.length-1]+".";}res.push(tmp+par);});return res;};events.filterEventsFrom=function(category,evts){var res=[];var tree=void 0;evts.forEach(function(ev){tree=events.getParentsTree(ev);var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=tree[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var e=_step.value;if(category===e){res.push(ev);break;}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}});return res;};events.eventIsA=function(evType,event){var evPar=event.split(".");var res=false;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=evPar[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var ev=_step2.value;if(ev===evType){res=true;}}}catch(err){_didIteratorError2=true;_iteratorError2=err;}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally{if(_didIteratorError2){throw _iteratorError2;}}}return res;};loadRulesHandlers$1(bq,events);return events;};var Mvt$1=function Mvt$1(world,origSquare){var vect=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[0,0];var mvt=void 0;mvt={src:origSquare,vect:vect,get dest(){return mvt.src.apply(mvt.vect);},add:function add(){for(var _len=arguments.length,vects=Array(_len),_key=0;_key<_len;_key++){vects[_key]=arguments[_key];}var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=vects[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var vec=_step3.value;mvt.vect[0]+=vec[0];mvt.vect[1]+=vec[1];}}catch(err){_didIteratorError3=true;_iteratorError3=err;}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return();}}finally{if(_didIteratorError3){throw _iteratorError3;}}}return mvt;},doesNothing:function doesNothing(){return mvt.vect[0]===0&&mvt.vect[1]===0;}};return mvt;};var Move$1=function Move$1(bq){var codes=bq.world.env.codes;var move={name:"bq.world.player.move",main:undefined,events:["bq.world.player.move"],instant:false,data:{"bq.world.player.move.up":[0,-1],"bq.world.player.move.down":[0,1],"bq.world.player.move.left":[-1,0],"bq.world.player.move.right":[1,0]},pre:{},post:{},idle:{}};move.main=function(bq,event){var dir=move.data[event];if(dir!==undefined){var mvt=Mvt$1(bq.world,bq.world.player.square,dir);Object.values(move.pre).forEach(function(func){mvt=func.main(bq,mvt);});if(!mvt.doesNothing()){bq.world.player.move(mvt);Object.values(move.post).forEach(function(func){func.main(bq,mvt);});bq.events.add("bq.world.player.moved");}}};move.pre.nogo={main:function main(bq,mvt_obj){var nogo=move.pre.nogo;if(nogo.data&&nogo.data.has(mvt_obj.dest.code)){if(opts.RULES.MOVE){bq.interface.disp.console.write("RULES MOVE NOGO "+mvt_obj.dest.type);}bq.interface.audio.players.actions.play("marteauhit");return Mvt$1(bq.world,mvt_obj.src);}else return mvt_obj;},data:new Set([codes.mountains,codes.border]),sounds:["bump_wall"]};move.pre.static_fights={main:function main(bq,mvt_obj){var p=bq.world.player;var res=mvt_obj;if(p.state===p.states.fighting){res=Mvt$1(bq.world,mvt_obj.src);}return res;}};move.post.letalSquares={main:function main(bq,mvt_obj){var letalTypes=move.post.letalSquares.data.map(function(x){return x[0];});if(letalTypes.includes(mvt_obj.dest.code)){var index=letalTypes.indexOf(mvt_obj.dest.code);var letalSounds=move.post.letalSquares.data.map(function(x){return x[1];});if(opts.RULES.MOVE){bq.interface.disp.console.write("RULES MOVE LETHAL "+mvt_obj.dest.type);}bq.interface.audio.players.actions.play(letalSounds[index]);bq.events.add("bq.world.player.kill");}},data:[[codes.water,"noyade"],[codes.sea,"noyade"]]};move.post.bonus={main:function main(bq,mvt_obj){if(mvt_obj.dest.code===codes.bonus){bq.events.add("bq.world.player.bonus");mvt_obj.dest.code=bq.world.getNewCode(mvt_obj.dest);}}};bq.events.register(move);return move;};var ToggleFullscreen$1=function ToggleFullscreen$1(bq){var fs={name:"bq.interface.fullscreen",events:["bq.interface.fullscreen"],instant:true,main:function main(){if(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled){if(document.fullscreen==false||document.webkitIsFullScreen==false){if(document.body.requestFullscreen){document.body.requestFullscreen();}else if(document.body.webkitRequestFullscreen){document.body.webkitRequestFullscreen();}else if(document.body.mozRequestFullScreen){document.body.mozRequestFullScreen();}else if(document.body.msRequestFullscreen){document.body.msRequestFullscreen();}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}}}}};bq.events.register(fs);return fs;};var ToggleMute$1=function ToggleMute$1(bq){var rule={name:"bq.interface.mute",main:undefined,events:["bq.interface.mute"],instant:true};rule.main=function(bq,event){bq.interface.audio.toggleMute();};bq.events.register(rule);return rule;};var formatType=function formatType(type,type_length){var res=void 0;if(type.length<type_length){res=type+" "*(type_length-type.length);}else if(type.length){res=type.slice(0,type_length);}return res;};var dispMapTxt=function dispMapTxt(map,type_length,bq){var player_pos=arguments.length>3&&arguments[3]!==undefined?arguments[3]:undefined;var table=document.createElement("table");var line=void 0,cell=void 0,content=void 0,tmp=void 0;map.forEach(function(l,li){line=document.createElement("tr");l.forEach(function(c,ci){cell=document.createElement("td");if(opts.DEV_TOOLS.SHOW_MAP_COLORS){cell.style.color=opts.ENV.COLORS[bq.world.env.code2Type(c)];}content=document.createTextNode(formatType(bq.world.env.code2Type(c),type_length));if(player_pos!==undefined&&ci==player_pos[0]&&li==player_pos[1]){tmp=document.createElement("strong");tmp.style.color="red";tmp.appendChild(content);content=tmp;}cell.appendChild(content);line.appendChild(cell);});table.appendChild(line);});return table;};var dispMapColor=function dispMapColor(map,square_size,bq){var player_pos=arguments.length>3&&arguments[3]!==undefined?arguments[3]:undefined;var table=document.createElement("table");var line=void 0,cell=void 0;map.forEach(function(l,li){line=document.createElement("tr");l.forEach(function(c,ci){cell=document.createElement("td");cell.style.height=cell.style.width=square_size;if(opts.DEV_TOOLS.SHOW_MAP_COLORS){cell.style.backgroundColor=opts.ENV.COLORS[bq.world.env.code2Type(c)];}if(opts.ENV.ROUND.has(bq.world.env.code2Type(c))){cell.style.borderRadius="100%";}if(player_pos!==undefined&&ci===player_pos[0]&&li===player_pos[1]){cell.style.boxShadow="-2px -2px red, 2px 2px red";}line.appendChild(cell);});table.appendChild(line);});return table;};var dispMap$1=function dispMap$1(map,type_length,square_size,bq){var player_pos=arguments.length>4&&arguments[4]!==undefined?arguments[4]:undefined;var table=void 0;switch(opts.DEV_TOOLS.SHOW_MAP_TYPE){case"txt":table=dispMapTxt(map,type_length,bq,player_pos);break;case"square":table=dispMapColor(map,square_size,bq,player_pos);break;default:break;}return table;};var ShowProxMap$1=function ShowProxMap$1(bq){if(opts.DEV_TOOLS.SHOW_PROX_MAP){var rule={name:"bq.world.player.moved showProxMap",main:undefined,events:["bq.world.player.moved"],instant:true,data:{type_length:2,radius:5,square_size:"5px"}};rule.main=function(bq,event){event;var pos=bq.world.player.square;var prox_map=bq.world.getProxMap(pos.x,pos.y,rule.data.radius);var table=dispMap$1(prox_map,rule.data.type_length,rule.data.square_size,bq,[rule.data.radius,rule.data.radius]);if(table!==undefined){table.id="proxMap";table.style.position="fixed";table.style.top="45vh";table.style.left="0";table.style.zIndex=100;table.style.textAlign="center";var tmp=document.getElementById("proxMap");if(tmp!=undefined)tmp.parentNode.removeChild(tmp);document.body.appendChild(table);}};bq.events.register(rule);return rule;}};var ShowProxMap$2=function ShowProxMap$2(bq){if(opts.DEV_TOOLS.SHOW_WHOLE_MAP){var rule={name:"bq.world.player.moved showProxMap",main:undefined,events:["bq.world.player.moved"],instant:true,data:{type_length:2,square_size:"10px"}};rule.main=function(bq,event){event;var table=dispMap$1(bq.world.data,rule.data.type_length,rule.data.square_size,bq,[bq.world.player.square.x,bq.world.player.square.y]);if(table!==undefined){table.id="map";table.style.position="fixed";table.style.top="0";table.style.right="0";table.style.zIndex=100;table.style.textAlign="center";table.style.color="white";table.style.fontSize="0.5em";var tmp=document.getElementById("map");if(tmp!=undefined)tmp.parentNode.removeChild(tmp);document.body.appendChild(table);}};bq.events.register(rule);return rule;}};var getDistance=function getDistance(x1,y1,x2,y2){return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));};var PlayEnvSounds$1=function PlayEnvSounds$1(bq){var rule={name:"bq.world.player.moved playEnvSound",main:undefined,events:["bq.world.player.moved"],instant:true,data:{radius:2,prox_sounds:new Set([bq.world.env.codes.water,bq.world.env.codes.sea,bq.world.env.codes.bridge]),prev_code:0}};rule.main=function(bq,event){event;var env_player=bq.interface.audio.players.env;var pos=bq.world.player.square;var rel_pos=void 0;var submap=bq.world.getProxMap(pos.x,pos.y,rule.data.radius);var distance=void 0,inv_dist=void 0;env_player.stopProx();submap.forEach(function(line,li){line.forEach(function(elmt,ei){rel_pos={x:ei-rule.data.radius,y:li-rule.data.radius};if(rel_pos.x===0&&rel_pos.y===0){if(elmt!==rule.data.prev_code){env_player.playPlayer(bq.world.env.code2sound(elmt));rule.data.prev_code=elmt;}bq.interface.audio.players.actions.play("walking-in-snow-soundjay_short");}else if(rule.data.prox_sounds.has(elmt)){distance=getDistance(0,0,rel_pos.x,rel_pos.y);inv_dist=1/distance;inv_dist=Number.parseFloat(inv_dist.toFixed(6));env_player.playProx(bq.world.env.code2sound(elmt),inv_dist);}});});env_player.debug_printAll();};bq.events.register(rule);return rule;};var Base=function Base(bq){var rule={name:"bq.game.state changeState",main:undefined,events:["bq.game.state"],instant:true,data:{"bq.game.state.init":bq.states.init,"bq.game.state.loaded":bq.states.loaded,"bq.game.state.launched":bq.states.launched,"bq.game.state.paused":bq.states.paused,"bq.game.state.stopped":bq.states.stopped,"bq.game.state.won":bq.states.won}};rule.main=function(bq,event){if(Object.keys(rule.data).includes(event)){bq.state=rule.data[event];}};bq.events.register(rule);return rule;};var Base$1=function Base$1(bq){var rule={name:"bq.game.pause",main:function main(bq,event){event;if(bq.state===bq.states.launched){bq.events.add("bq.game.state.paused");}else if(bq.state===bq.states.paused){bq.events.add("bq.game.state.launched");}},events:["bq.game.pause"],instant:true};bq.events.register(rule);return rule;};var Base$2=function Base$2(bq){var rule={name:"bq.game.stop",main:function main(bq,event){event;bq.events.add("bq.game.state.stopped");},events:["bq.game.stop"],instant:true};bq.events.register(rule);return rule;};var Base$3=function Base$3(bq){return bq.events.register({name:"bq.game.reset",main:function main(bq){bq.reset(bq);},events:["bq.game.reset"],instant:true});};var Base$4=function Base$4(bq){var rule={name:"bq.world.player.bonus",main:undefined,events:["bq.world.player.bonus"],instant:false,data:{effect:5}};rule.main=function(bq,event){event;bq.world.player.life+=rule.data.effect;bq.interface.audio.players.actions.play("bonus");};bq.events.register(rule);return rule;};var Base$5=function Base$5(bq){var codes=bq.world.env.codes;var rule={name:"bq.world.player.moved start_fight",main:undefined,events:["bq.world.player.moved"],instant:true,data:new Set([codes.monster,codes.boss,codes.boss_final])};rule.main=function(bq,event){event;var p=bq.world.player;if(rule.data.has(p.square.code)){p.createEnemy(p.square);p.state=p.states.fighting;bq.interface.disp.console.writeState("fight");bq.events.add("bq.world.player.fight_started");}};bq.events.register(rule);return rule;};var Base$6=function Base$6(bq){var rule={name:"bq.world.player.attack",main:undefined,events:["bq.world.player.attack"],instant:false,data:{}};var fight=function fight(attacker,receiver,sound_hit,sound_missed,receiver_hurt,callback){if(Math.random()<attacker.proba_hit){bq.interface.audio.players.actions.play(sound_hit,1,function(){return bq.interface.audio.players.actions.play(receiver_hurt,1,function(){});});if(opts.DEBUG.FIGHTS){bq.interface.disp.console.write("FIGHT HIT A : "+attacker.life+" R : "+(receiver.life-attacker.damages)+" PROBA : "+attacker.proba_hit);}receiver.life-=attacker.damages;}else{if(opts.DEBUG.FIGHTS){bq.interface.disp.console.write("FIGHT MISSED");}bq.interface.audio.players.actions.play(sound_missed,1);}if(callback)callback();};rule.main=function(bq,event){event;var p=bq.world.player;if(p.state==p.states.fighting){fight(p,p.cur_enemy,"epeehit","epeemissed","monstreblesse",function(){return fight(p.cur_enemy,p,"marteauhit","epeemissed","joueurblesse");});}};bq.events.register(rule);return rule;};var Base$7=function Base$7(bq){var rule={name:"bq.world.player.end_fight",main:undefined,events:["bq.world.player.end_fight"],instant:true,data:{}};rule.main=function(bq,event){event;var p=bq.world.player;if(p.cur_enemy.life<=0){p.state=p.states.wandering;p.square.code=bq.world.getNewCode(p.square);bq.interface.disp.console.writeState("fight end");bq.events.add("bq.world.player.moved");}};bq.events.register(rule);return rule;};var Base$8=function Base$8(bq){var rule={name:"bq.world.player.life_changed heartbeat",main:undefined,events:["bq.world.player.life_changed"],instant:true,data:{start_under:10}};var heart_p=bq.interface.audio.players.heart;rule.main=function(bq,event){event;var p=bq.world.player;if(p.life<=0||p.life>rule.data.start_under){heart_p.pause();}else if(p.life<=rule.data.start_under){heart_p.play((rule.data.start_under-p.life)/rule.data.start_under);}};bq.events.register(rule);return rule;};var Base$9=function Base$9(bq){if(opts.DEV_TOOLS.SHOW_LIFE){var rule={name:"bq.world.player.life_changed dispLife",main:undefined,events:["bq.world.player.life_changed","bq.game.state.loaded"],instant:true};var tmp=document.getElementById("life");if(tmp!==null){document.body.removeChild(tmp);}var txt=document.createElement("h1");txt.style="position:fixed;top:10px;left:10px;margin:0;";txt.id="life";document.body.appendChild(txt);rule.main=function(bq,event){event;document.getElementById("life").textContent=bq.world.player.life;};bq.events.register(rule);return rule;}};var Base$10=function Base$10(bq){var rule=undefined;if(opts.AUDIO.START_MUTE===true){rule={name:"bq.game.state.loaded startMute",events:["bq.game.state.loaded"],main:function main(bq){bq.interface.audio.isMute=true;},instant:true};bq.events.register(rule);}return rule;};var Base$11=function Base$11(bq){var rule={name:"bq.world.player.end_fight victory",main:undefined,events:["bq.world.player.end_fight"],instant:false};rule.main=function(bq,event){event;var p=bq.world.player;if(p.cur_enemy.life<=0&&p.cur_enemy.id===bq.world.env.codes.boss_final){bq.events.add("bq.game.state.won");bq.interface.audio.players.env.stopAll();bq.interface.audio.players.env.playPlayer("victoire");}};bq.events.register(rule);return rule;};var Base$12=function Base$12(bq){var popup=bq.interface.disp.popup;return bq.events.register({name:"bq.game.help",events:["bq.game.help"],main:function main(bq,event){event;if(!popup.isUp){popup.write(" H : Display and hide this message.\n\
                 : go north,  : south,  : west, et  : east\n\
                P : Pause/resume the game.\n\
                F : Enable/disable fullscreen mode.\n\
                M : mute.\n\
                SPACE BAR : Attack during fights.\n\
                R : Reset the game anytime.\nS : Save\n\
                C : Load a world or a savefile.");}else{popup.remove();}},instant:true});};var download=function download(data,filename,type){var file=new Blob([data],{type:type});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(file,filename);else{var a=document.createElement("a"),url=URL.createObjectURL(file);a.href=url;a.download=filename;document.body.appendChild(a);a.click();setTimeout(function(){document.body.removeChild(a);window.URL.revokeObjectURL(url);},0);}};var Base$13=function Base$13(bq){var rule={name:"bq.game.save",events:["bq.game.save"],main:undefined,instant:false,data:{}};rule.main=function(bq,event){event;var player=bq.world.player;var save_obj={world:{name:bq.world.name,data:bq.world.data,player:{pos:[player.square.x,player.square.y],life:player.life,damages:player.damages}}};var txt=JSON.stringify(save_obj);download(txt,"save_"+save_obj.world.name+"_"+Date.now()+".json","application/json");};bq.events.register(rule);return rule;};var Base$14=function Base$14(bq){var rule={name:"bq.game.load",events:["bq.game.load"],main:undefined,instant:true};var popup=bq.interface.disp.popup;rule.main=function(bq,event){event;if(popup.isUp){popup.remove();}else{var input=document.createElement("input");input.type="file";input.onchange=function(){bq.src=input.files[0];bq.events.add("bq.game.reset");popup.remove();};popup.write("Click here to load a savefile or a world :",input);input.click();}};bq.events.register(rule);return rule;};var Base$15=function Base$15(bq){return bq.events.register({name:"bq.world.player.kill",events:["bq.world.player.kill"],main:function main(bq){bq.world.player.life=0;},instant:true});};var Rules$1=function Rules$1(bq){var rules={clean:function clean(){},move:Move$1(bq),toggle_fullscreen:ToggleFullscreen$1(bq),toggle_mute:ToggleMute$1(bq),show_prox_map:ShowProxMap$1(bq),show_whole_map:ShowProxMap$2(bq),play_env_sounds:PlayEnvSounds$1(bq),change_state:Base(bq),pause:Base$1(bq),stop:Base$2(bq),reset:Base$3(bq),bonus:Base$4(bq),start_fight:Base$5(bq),player_attack:Base$6(bq),end_fight:Base$7(bq),heartbeat:Base$8(bq),disp_life:Base$9(bq),start_mute:Base$10(bq),victory:Base$11(bq),show_help:Base$12(bq),save:Base$13(bq),load:Base$14(bq),kill:Base$15(bq)};return rules;};var Keyboard$1=function Keyboard$1(events,consoleInterface){var kb={conf:{world:{player:{move:{up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight"},attack:" "}},interface:{fullscreen:"f",mute:"m",pause:"p"},game:{reset:"r",help:"h",save:"s",load:"c"}},keydown:undefined};kb.keydown=function(event){var msg="";switch(event.key){case kb.conf.world.player.move.up:events.add("bq.world.player.move.up");break;case kb.conf.world.player.move.down:events.add("bq.world.player.move.down");break;case kb.conf.world.player.move.left:events.add("bq.world.player.move.left");break;case kb.conf.world.player.move.right:events.add("bq.world.player.move.right");break;case kb.conf.interface.fullscreen:events.add("bq.interface.fullscreen");break;case kb.conf.interface.mute:events.add("bq.interface.mute");break;case kb.conf.interface.pause:events.add("bq.game.pause");break;case kb.conf.world.player.attack:events.add("bq.world.player.attack");break;case kb.conf.game.reset:events.add("bq.game.reset");break;case kb.conf.game.help:events.add("bq.game.help");break;case kb.conf.game.save:events.add("bq.game.save");break;case kb.conf.game.load:events.add("bq.game.load");break;default:msg="NOEVENT ";}if(opts.DEBUG.KB){consoleInterface.write("\tINPUT KB "+msg+event.key);}};document.addEventListener("keydown",kb.keydown);return kb;};var Input$1=function Input$1(events,consoleInterface){var input={kb:undefined};input.kb=Keyboard$1(events,consoleInterface);return input;};var audioFold="audio/";var extractName=function extractName(howler_obj){return howler_obj._src.replace(/audio\/webm\/([^.\/]*).*/,function(x,y){return y;});};var stringifyList=function stringifyList(list){return list.map(function(x){return extractName(x)+"("+x.volume()+")";}).join(", ");};var keepPlayingTracks=function keepPlayingTracks(list){var res=[];list.forEach(function(elmt){if(elmt.playing()){res.push(elmt);}});return res;};var Env=function Env(consoleInterface){var prox_sounds=[];var player_sound=undefined;var stopPlayer=function stopPlayer(){if(player_sound!==undefined){player_sound.stop();player_sound=undefined;}};var stopProx=function stopProx(){prox_sounds.forEach(function(s){return s.stop();});if(prox_sounds.length>0&&opts.DEBUG.AUDIO&&opts.DEBUG.AUDIO_STOP){var names=stringifyList(prox_sounds);consoleInterface.write("AUDIO ENV STOP "+names);}prox_sounds.length=0;};var stopAll=function stopAll(){stopProx();stopPlayer();};var play=function play(soundName){var volume=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;var sound=new Howl({src:[audioFold+"webm/"+soundName+".webm",audioFold+"mp3/"+soundName+".mp3"],loop:true,volume:volume*opts.AUDIO.VOLUME_ENV,onloaderror:function onloaderror(id,msg){consoleInterface.write("AUDIO ERROR "+soundName+" : "+msg);}});sound.play();if(opts.DEBUG.AUDIO&&opts.DEBUG.AUDIO_PLAY){consoleInterface.write("AUDIO ENV PLAY "+soundName+" VOL "+volume);}return sound;};var playPlayer=function playPlayer(soundName){var volume=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;stopPlayer();player_sound=play(soundName,volume*opts.AUDIO.VOLUME_ENV_PLAYER);};var playProx=function playProx(soundName){var volume=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;prox_sounds.push(play(soundName,volume*opts.AUDIO.VOLUME_ENV_PROX));};return{playPlayer:playPlayer,playProx:playProx,stopPlayer:stopPlayer,stopProx:stopProx,stopAll:stopAll,debug_printAll:function debug_printAll(){if(opts.DEBUG.AUDIO){consoleInterface.write("AUDIO ENV PLAY "+stringifyList([player_sound].concat(prox_sounds)));}}};};var Actions=function Actions(consoleInterface){var act_sounds=[];var stopAll=function stopAll(){act_sounds.forEach(function(s){return s.stop();});if(act_sounds.length>0&&opts.DEBUG.AUDIO&&opts.DEBUG.AUDIO_STOP){var names=stringifyList(act_sounds);consoleInterface.write("AUDIO ACTION STOP "+names);}act_sounds.length=0;};var play=function play(soundName){var volume=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;var callback=arguments.length>2&&arguments[2]!==undefined?arguments[2]:undefined;act_sounds=keepPlayingTracks(act_sounds);var sound=new Howl({src:[audioFold+"webm/"+soundName+".webm",audioFold+"mp3/"+soundName+".mp3"],onloaderror:function onloaderror(id,msg){consoleInterface.write("AUDIO ERROR "+soundName+" : "+msg);},volume:volume*opts.AUDIO.VOLUME_ACTION});act_sounds.push(sound);sound.play();if(opts.DEBUG.AUDIO&&opts.DEBUG.AUDIO_PLAY){consoleInterface.write("AUDIO ACTION PLAY "+soundName);}if(callback!==undefined){sound.on("end",callback);}};return{play:play,stopAll:stopAll,debug_printAll:function debug_printAll(){if(opts.DEBUG.AUDIO){consoleInterface.write("AUDIO ENV PLAY "+stringifyList(act_sounds));}}};};var Heart=function Heart(consoleInterface){var soundName="heartbeat";var heartbeat=new Howl({src:[audioFold+"webm/"+soundName+".webm",audioFold+"mp3/"+soundName+".mp3"],autoplay:false,loop:true,onloaderror:function onloaderror(id,msg){consoleInterface.write("AUDIO ERROR "+soundName+" : "+msg);},volume:opts.AUDIO.VOLUME_HEART});heartbeat.pause();var pause=function pause(){heartbeat.pause();};var play=function play(){var volume=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;heartbeat.volume(volume*opts.AUDIO.VOLUME_HEART);if(!heartbeat.playing())heartbeat.play();if(opts.DEBUG.AUDIO&&opts.DEBUG.AUDIO_PLAY){consoleInterface.write("AUDIO HEART PLAY "+heartbeat.volume());}};return{play:play,pause:pause,stopAll:function stopAll(){heartbeat.stop();}};};var Audio$1=function Audio$1(consoleInterface){var ismute=false;var audio={players:{env:Env(consoleInterface),actions:Actions(consoleInterface),heart:Heart(consoleInterface)},get isMute(){return ismute;},set isMute(val){ismute=val;if(opts.DEBUG.AUDIO){consoleInterface.write("AUDIO "+(audio.isMute?"MUTE":"DE-MUTE"));}Howler.mute(val);return ismute;},toggleMute:undefined,stopAll:undefined};audio.toggleMute=function(){audio.isMute^=true;};audio.stopAll=function(){Object.keys(audio.players).forEach(function(key){return audio.players[key].stopAll();});};return audio;};var Display_Msg=function Display_Msg(){return{write:function write(msg){document.getElementById("msg").textContent=msg;}};};var Display_PopUp=function Display_PopUp(){var p=void 0;p={get isUp(){return document.getElementById("popUp")!==null;},write:function write(msg){var dom_elmt=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;var txt=document.createElement("p");var tmp_list=msg.split("\n");tmp_list.forEach(function(line){txt.appendChild(document.createTextNode(line));txt.appendChild(document.createElement("br"));});p.popUp(txt,dom_elmt);},popUp:function popUp(){var popup=document.createElement("div");var closeBtn=document.createElement("button");closeBtn.textContent="Close [x]";closeBtn.style.position="absolute";closeBtn.style.top="0";closeBtn.style.right="0";closeBtn.style.borderRadius="0";closeBtn.style.border="none";closeBtn.style.background="none";closeBtn.style.color="#fff";closeBtn.onclick=p.remove;popup.appendChild(closeBtn);for(var _len2=arguments.length,dom_elmts=Array(_len2),_key2=0;_key2<_len2;_key2++){dom_elmts[_key2]=arguments[_key2];}dom_elmts.forEach(function(elmt){if(elmt!=undefined){popup.appendChild(elmt);}});popup.id="popUp";popup.style.position="fixed";popup.style.background="#333";popup.style.backgroundColor="#333A";popup.style.top="10vh";popup.style.left="10vw";popup.style.zIndex="1000";popup.style.minWidth="80%";popup.style.maxWidth="80%";popup.style.maxHeight="80%";popup.style.padding="20px";popup.style.margin="auto";p.remove();document.body.appendChild(popup);},remove:function remove(){var tmp=document.getElementById("popUp");if(tmp!=undefined)tmp.parentNode.removeChild(tmp);}};return p;};var formatDebug=function formatDebug(msg,length_total,length_limits){var spaces=(length_total-msg.length-length_limits*2)/2;var lims="";for(var i=0;i<length_limits;i++){lims+="#";}var spaces_r="";for(var _i=0;_i<=spaces-1;_i++){spaces_r+=" ";}var spaces_l=spaces_r+(spaces%1!==0?" ":"");return lims+spaces_l+msg+spaces_r+lims;};var Display_Console=function Display_Console(){return{write:function write(msg){if(!opts.DEBUG.DISABLE){console.log(msg);}},writeState:function writeState(msg){var length_total=arguments.length>1&&arguments[1]!==undefined?arguments[1]:30;var length_limits=arguments.length>2&&arguments[2]!==undefined?arguments[2]:9;if(!opts.DEBUG.DISABLE){console.log(formatDebug(msg,length_total,length_limits));}}};};var Display$1=function Display$1(){var disp={msg:Display_Msg(),popup:Display_PopUp(),console:Display_Console(),write:undefined,writeState:undefined,error:undefined};disp.write=function(msg){var debugMsg=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;disp.msg.write(msg);disp.console.write(debugMsg===undefined?msg:debugMsg);};disp.writeState=function(msg){var debugMsg=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;var length_total=arguments[2];var length_limits=arguments[3];disp.msg.write(msg);disp.console.writeState(debugMsg===undefined?msg:debugMsg,length_total,length_limits);};disp.error=function(msg){var debugMsg=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;disp.write(msg,debugMsg);};return disp;};var Interface$1=function Interface$1(events){var inter={input:undefined,audio:undefined,disp:Display$1(),clean:undefined};inter.audio=Audio$1(inter.disp.console);inter.input=Input$1(events,inter.disp.console);inter.clean=function(){document.removeEventListener("keydown",inter.input.kb.keydown);inter.audio.stopAll();};return inter;};var reverseObj=function reverseObj(inObj){var res={};Object.keys(inObj).forEach(function(elmt){res[inObj[elmt]]=elmt;});return res;};var Env$2=function Env$2(){var env={codes:{},code2Type:undefined,sounds:{squares:{},effects:{}},code2sound:undefined};env.codes=opts.ENV.CODES;var conv_codes=reverseObj(env.codes);env.code2Type=function(code){return conv_codes[code];};env.sounds.squares=opts.ENV.SOUNDS;env.code2sound=function(code){return env.sounds.squares[env.code2Type(code)];};return env;};var Player$1=function Player$1(bq,startSquare){var life=opts.PLAYER.MAX_LIFE;var player=void 0;player={square:undefined,get life(){return life;},set life(nlife){life=nlife>opts.PLAYER.MAX_LIFE?opts.PLAYER.MAX_LIFE:nlife;if(life<=0){player.die(bq);}bq.events.add("bq.world.player.life_changed");return life;},damages:opts.PLAYER.DEFAULT_DAMAGES,proba_hit:opts.PLAYER.PROBA_HIT,move:undefined,placeOn:undefined,die:undefined,createEnemy:undefined,state:0,states:{wandering:1,dead:2,fighting:3},cur_enemy:undefined};player.placeOn=function(square){player.square=square;if(square!==undefined){bq.interface.disp.console.write("PLAYER PLACED AT ("+square.x+","+square.y+") ON "+square.type);}};player.move=function(mvt_obj){player.square=mvt_obj.dest;if(opts.RULES.MOVE){bq.interface.disp.console.write("PLAYER MOVED TO ("+player.square.x+","+player.square.y+") ON "+player.square.type);}};player.die=function(bq){player.state=player.states.dead;bq.interface.audio.players.actions.play("mortcombat");bq.events.add("bq.game.stop");bq.interface.disp.console.write("PLAYER KILLED");};player.createEnemy=function(square){var en=opts.MONSTERS[square.code];var life=en.life;if(en!==undefined){player.cur_enemy={id:en.id,get life(){return life;},set life(new_life){life=new_life;if(life<=0){player.cur_enemy.die();}},damages:en.damages,get proba_hit(){return player.cur_enemy.life>0?en.proba_hit:en.proba_death;},die:function die(){bq.events.add("bq.world.player.end_fight");}};}};player.placeOn(startSquare);player.state=player.states.wandering;return player;};function Square$1(world,x,y){var sq=void 0;var _x=0,_y=0;sq={get x(){return _x;},set x(val){return _x=world.correctX(val);},get y(){return _y;},set y(val){return _y=world.correctY(val);},get code(){return world.getSquareCode(sq.x,sq.y);},set code(new_code){return world.data[sq.y][sq.x]=new_code;},get type(){return world.getSquareType(sq.x,sq.y);},get sound(){return world.env.sounds.squares[sq.type];},apply:undefined};sq.apply=function(vect){return Square$1(world,sq.x+vect[0],sq.y+vect[1]);};sq.x=x;sq.y=y;return sq;}var clearBehind=function clearBehind(submap,c_x,c_y,radius){var center_xy=radius;var vu=[0,0],hyp=0;var safety_counter=0;var tmp_x=0,tmp_y=0;vu=[c_x-center_xy,c_y-center_xy];hyp=Math.sqrt(vu[0]*vu[0]+vu[1]*vu[1]);vu[0]=vu[0]/hyp;vu[1]=vu[1]/hyp;tmp_x=c_x+vu[0];tmp_y=c_y+vu[1];while(safety_counter<100000&&0<=tmp_x&&tmp_x<=2*radius&&0<=tmp_y&&tmp_y<=2*radius){submap[Math.round(tmp_y)][Math.round(tmp_x)]=opts.ENV.CODES.border;tmp_x+=vu[0];tmp_y+=vu[1];safety_counter++;}return submap;};var loadWorldFile=function loadWorldFile(world,fileContent){checkWorld(fileContent.world);world.name=fileContent.world.name;world.data=fileContent.world.data;if(fileContent.world.player!==undefined){var p=fileContent.world.player;if(p.pos!==undefined){world.player.placeOn(Square$1.apply(undefined,[world].concat(_toConsumableArray(p.pos))));}if(p.life!==undefined){world.player.life=p.life;}if(p.damages!==undefined){world.player.damages=p.damages;}}else{world.player.placeOn(findStartSquare(world));}world.isReady=true;return world;};var fetchWorldFile=function fetchWorldFile(bq){var json_promise=void 0;if(bq.src instanceof File){var reader=new FileReader();reader.readAsText(bq.src);json_promise=new Promise(function(resolve){reader.onloadend=function(){return resolve(JSON.parse(reader.result));};});}else{json_promise=fetch(new Request(bq.src)).then(function(response){return response.json();});}bq.src=undefined;return json_promise;};var checkWorld=function checkWorld(world){if(world.name.length==0)throw new Error("Empty world name.");var refLineSize=world.data[0].length;world.data.forEach(function(line,indexY){if(line.length!=refLineSize)throw new Error("Line "+indexY+" isn't the same length as the previous ones.");});};var findStartSquare=function findStartSquare(world){var pos=undefined;world.data.forEach(function(y,indexY){y.map(function(x,indexX){if(x===world.env.codes.start){pos=[indexX,indexY];}});});if(pos===undefined){throw new Error("No start square was found.");}return Square$1.apply(undefined,[world].concat(_toConsumableArray(pos)));};var World$1=function World$1(bq){var world={isReady:false,name:"",data:[[]],env:{},player:{},get height(){return world.data.length;},get width(){return world.data[0].length;},correctX:function correctX(x){var i=x;if(i<0){i=world.width-1+i%world.width;}else if(i>world.width-1){i%=world.width;}return i;},correctY:function correctY(y){var i=y;if(i<0){i=world.height-1+i%world.height;}else if(i>world.height-1){i%=world.height;}return i;},getSquare:function getSquare(x,y){return Square$1(world,x,y);},getSquareCode:function getSquareCode(x,y){var i=world.correctX(x),j=world.correctY(y);return world.data[j][i];},getSquareType:function getSquareType(x,y){return world.env.code2Type(world.getSquareCode(x,y));},getSubMap:function getSubMap(x1,y1,x2_or_radius,y2){var res=[],tmp=void 0,i=void 0,j=void 0;if(y2===undefined){x1-=x2_or_radius;y1-=x2_or_radius;y2=y1+x2_or_radius*2;x2_or_radius=x1+x2_or_radius*2;}for(j=y1;j<=y2;j++){tmp=[];for(i=x1;i<=x2_or_radius;i++){tmp.push(world.data[world.correctY(j)][world.correctX(i)]);}res.push(tmp);}return res;},getProxMap:function getProxMap(x,y,radius){var t_start=Date.now();var submap=world.getSubMap(x,y,radius);if(radius>1){var center_xy=radius;var c_rad=1,c_x=center_xy,c_y=center_xy-1,c_code=0,prev_blocker=false,move=[1,0];while(c_rad<radius){c_code=submap[c_y][c_x];if(Object.keys(opts.ENV.SOUND_BLOCKERS).includes(String(c_code))){submap=clearBehind(submap,c_x,c_y,radius);if(prev_blocker===true){submap=clearBehind(submap,c_x-move[0]/2,c_y-move[1]/2,radius);}prev_blocker=true;}else{prev_blocker=false;}if(c_x===center_xy-c_rad&&c_y===center_xy-c_rad){c_rad++;if(Object.keys(opts.ENV.SOUND_BLOCKERS).includes(String(submap[c_y][c_x+1]))){submap=clearBehind(submap,c_x+1/2,c_y,radius);}move=[0,-1];}else if(c_y===center_xy-c_rad&&c_x===center_xy-c_rad+1){move=[1,0];}else if(c_y===center_xy-c_rad&&c_x===center_xy+c_rad){move=[0,1];}else if(c_y===center_xy+c_rad&&c_x===center_xy+c_rad){move=[-1,0];}else if(c_y===center_xy+c_rad&&c_x===center_xy-c_rad){move=[0,-1];}c_x+=move[0];c_y+=move[1];}}if(opts.DEBUG.TIME.GETPROXMAP){bq.interface.disp.console.write("WORLD GETPROXMAP "+(Date.now()-t_start)+"ms");}return submap;},getNewCode:undefined,isSquareCodeGood:function isSquareCodeGood(code){return!opts.BAD_SQUARES_CODES.has(code);},launch:function launch(){bq.events.add("bq.world.player.moved");},clean:function clean(){}};world.getNewCode=function(square){var dir_list=[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[1,-1],[-1,1],[1,1]];var res=world.env.codes.plain;var code=void 0;var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=dir_list[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var i=_step4.value;code=square.apply(i).code;if(world.isSquareCodeGood(code)){res=code;break;}}}catch(err){_didIteratorError4=true;_iteratorError4=err;}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return();}}finally{if(_didIteratorError4){throw _iteratorError4;}}}return res;};world.env=Env$2();world.player=Player$1(bq);return fetchWorldFile(bq).then(function(response){return Promise.resolve(loadWorldFile(world,response));});};var getLastElmt=function getLastElmt(event){var tmp=event.split(".");return tmp[tmp.length-1];};var Base$16=function Base$16(bq){var rule={name:"bq.game.state",main:undefined,events:["bq.game.state"],instant:true,data:{"bq.game.state.loading":"Game loading world...","bq.game.state.loaded":"Game loaded.","bq.game.state.launching":"Launching game...","bq.game.state.launched":"Game launched, have fun!","bq.game.state.stopped":"Game stopped (you either died or quit) (press r to restart).","bq.game.state.paused":"Game paused (press p to resume).","bq.game.state.won":"Game finished, you won ! (press r to restart).",length_total:30,length_limits:9}};rule.main=function(bq,event){if(Object.keys(rule.data).includes(event)){bq.interface.disp.writeState(rule.data[event],getLastElmt(event),rule.data.length_total,rule.data.length_limits);}};bq.events.register(rule);return rule;};var Bq$1=function Bq$1(src){var bq={state:0,src:src,world:{not_loaded:true},interface:{not_loaded:true},rules:{not_loaded:true},events:{not_loaded:true},reset:undefined,load:undefined,launch:undefined,play:undefined,prev_time:Date.now(),states:{init:0,loaded:1,launched:2,paused:3,stopped:4,won:5}};bq.load=function(){var t_start=Date.now();if(!opts.DEBUG.DISABLE&&opts.DEBUG.BQ){console.log(bq);}if(!bq.events.not_loaded){bq.events.clean();}if(!bq.interface.not_loaded){bq.interface.clean();}if(!bq.world.not_loaded){bq.world.clean();}if(!bq.rules.not_loaded){bq.rules.clean();}if(bq.src===undefined){bq.src=opts.BQ.FILENAME;}bq.events=Events$1(bq);bq.interface=Interface$1(bq.events);Base$16(bq);bq.events.add("bq.game.state.loading");World$1(bq).then(function(world){bq.world=world;return Promise.resolve();}).then(function(){bq.rules=Rules$1(bq);return Promise.resolve();}).then(function(){bq.events.add("bq.game.state.loaded");return Promise.resolve();}).then(function(){bq.launch();return Promise.resolve();}).then(function(){if(opts.DEBUG.TIME.LOAD){bq.interface.disp.console.write("BQ LOADED IN "+(Date.now()-t_start)+"ms");}return Promise.resolve();});};bq.reset=function(){if(bq.state===bq.states.stopped||bq.state===bq.states.won){bq.load(bq);}bq.events.add("bq.game.state.init");};bq.launch=function(){bq.events.add("bq.game.state.launching");if(bq.state===bq.states.loaded){bq.world.launch();bq.events.add("bq.game.state.launched");return bq.play();}else{bq.interface.disp.error("BlindQuest is not fully loaded !");return bq;}};bq.play=function(){if(opts.DEBUG.TIME.BET_LOOPS&&-opts.BQ.TIMEBASE+Date.now()-bq.prev_time>opts.DEBUG.TIME.LIMIT/100*opts.BQ.TIMEBASE){bq.interface.disp.console.write("BQ LOOP AFTER "+(Date.now()-bq.prev_time)+"ms");}bq.prev_time=Date.now();var events=bq.events.getPendingsUniq(true);var t_start=Date.now();if(bq.state===bq.states.launched){bq.events.handle(events);}if(bq.state===bq.states.launched||bq.state===bq.states.paused){setTimeout(function(){return bq.play();},opts.BQ.TIMEBASE-(Date.now()-t_start));}else if(bq.state===bq.states.init){bq.load(bq);}if(opts.DEBUG.TIME.LOOP&&events.length>opts.DEBUG.TIME.LIMIT){bq.interface.disp.console.write("BQ LOOP DONE IN "+(Date.now()-t_start)+"ms");}return bq;};bq.load();return bq;};var main=function main(){Bq$1();};document.addEventListener("DOMContentLoaded",main);